name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Load secrets from GitHub
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        PGADMIN_EMAIL: ${{ secrets.PGADMIN_EMAIL }}
        PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}
        API_PORT: ${{ secrets.API_PORT || '8080' }}
      run: |
        echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ GitHub"
        
        echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_TOKEN" >> $GITHUB_ENV
        echo "POSTGRES_DB=$POSTGRES_DB" >> $GITHUB_ENV
        echo "POSTGRES_USER=$POSTGRES_USER" >> $GITHUB_ENV
        echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> $GITHUB_ENV
        echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
        
        cat << EOF > .env
        TELEGRAM_BOT_TOKEN=$TELEGRAM_TOKEN
        POSTGRES_DB=$POSTGRES_DB
        POSTGRES_USER=$POSTGRES_USER
        POSTGRES_PASSWORD=$POSTGRES_PASSWORD
        PGADMIN_DEFAULT_EMAIL=$PGADMIN_EMAIL
        PGADMIN_DEFAULT_PASSWORD=$PGADMIN_PASSWORD
        API_PORT=$API_PORT
        NODE_ENV=${{ inputs.environment }}
        EOF
        
        echo "üìÑ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .env"

    - name: Display deployment info
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."
        echo "üéØ –û–∫—Ä—É–∂–µ–Ω–∏–µ: ${{ inputs.environment }}"
        echo "üè∑Ô∏è  –í–µ—Ä—Å–∏—è –æ–±—Ä–∞–∑–∞: ${{ inputs.image_tag }}"
        echo "üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${{ env.POSTGRES_DB }}"

    - name: Deploy to ${{ inputs.environment }}
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        DB_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: |
        echo "Deploying to ${{ inputs.environment }} with tag ${{ inputs.image_tag }}"
        echo "‚úÖ Deployment to ${{ inputs.environment }} completed!"
