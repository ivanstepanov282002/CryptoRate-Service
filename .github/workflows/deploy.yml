name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Load secrets from GitHub
      env:
        # –í—Å–µ 7 —Å–µ–∫—Ä–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        PGADMIN_EMAIL: ${{ secrets.PGADMIN_EMAIL }}
        PGADMIN_PASSWORD: ${{ secrets.PGADMIN_PASSWORD }}
        API_PORT: ${{ secrets.API_PORT || '8080' }}
      run: |
        echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ GitHub"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ GITHUB_ENV –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —à–∞–≥–∞—Ö
        echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_TOKEN" >> $GITHUB_ENV
        echo "POSTGRES_DB=$POSTGRES_DB" >> $GITHUB_ENV
        echo "POSTGRES_USER=$POSTGRES_USER" >> $GITHUB_ENV
        echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> $GITHUB_ENV
        echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
        
        # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        cat << EOF > .env
        # Telegram
        TELEGRAM_BOT_TOKEN=$TELEGRAM_TOKEN
        
        # Database
        POSTGRES_DB=$POSTGRES_DB
        POSTGRES_USER=$POSTGRES_USER
        POSTGRES_PASSWORD=$POSTGRES_PASSWORD
        
        # PgAdmin
        PGADMIN_DEFAULT_EMAIL=$PGADMIN_EMAIL
        PGADMIN_DEFAULT_PASSWORD=$PGADMIN_PASSWORD
        
        # App
        API_PORT=$API_PORT
        NODE_ENV=${{ inputs.environment }}
        EOF
        
        echo "üìÑ –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª .env"
        echo "üîí –°–µ–∫—Ä–µ—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã (–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö)"

    - name: Display deployment info
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞—é —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."
        echo "üéØ –û–∫—Ä—É–∂–µ–Ω–∏–µ: ${{ inputs.environment }}"
        echo "üè∑Ô∏è  –í–µ—Ä—Å–∏—è –æ–±—Ä–∞–∑–∞: ${{ inputs.image_tag }}"
        echo "üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${{ env.POSTGRES_DB }}"
        echo "üîë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î: ${{ env.POSTGRES_USER }}"
        echo "üîå API –ø–æ—Ä—Ç: ${{ env.API_PORT || '8080' }}"

    - name: Deploy to ${{ inputs.environment }}
      env:
        # –ü–µ—Ä–µ–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –≤ —ç—Ç–æ—Ç —à–∞–≥ —Ç–æ–∂–µ
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        DB_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      run: |
        echo "Deploying to ${{ inputs.environment }} with tag ${{ inputs.image_tag }}"
        
        echo "‚úÖ Deployment to ${{ inputs.environment }} completed!"
        echo "üîê –°–µ–∫—Ä–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
        echo "üìÅ –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"